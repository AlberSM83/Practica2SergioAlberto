---
title: "PRA2 Tipología y ciclo de vida de los datos"
author: "Sergio Romero Córdoba y Alberto Sánchez Mazarro y S"
date: "11/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(stringr)
library(sjmisc)
library(dplyr)
#library(raster)
library(lubridate)
library(psych)
library(ggplot2)
library(conflicted)
library(ragtop)
library(car)
conflict_prefer("select", "dplyr")
#conflict_prefer("trim", "raster")
conflict_prefer("rescale", "scales")
conflict_prefer("filter", "dplyr")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

## 1. Cargamos los csv. Convertimos a UTF8 para solucionar el problema de las tildes
```{r}
#fichero Train
datosTrain <- read.csv("C:\\TRABAJO\\Master\\Tipologia\\PRA2\\train.csv", stringsAsFactors = FALSE, fileEncoding = "UTF-8")
#fichero Test
datosTest <- read.csv("C:\\TRABAJO\\Master\\Tipologia\\PRA2\\test.csv", stringsAsFactors = FALSE, fileEncoding = "UTF-8")
#fichero de supervivencia
datosSurvived <- read.csv("C:\\TRABAJO\\Master\\Tipologia\\PRA2\\gender_submission.csv", stringsAsFactors = FALSE, fileEncoding = "UTF-8")
```


## 2. Integración y selección.
A continuación vamos a integrar todos los datos en un único dataset.
```{r}
#Añadimos la variable "Survived" al dataset de Test
datosTestSurv<-merge(datosTest, datosSurvived, by.x="PassengerId", by.y="PassengerId")

#Mezclamos el nuevo dataset de test y el de train
datos<-rbind(datosTestSurv, datosTrain)

#Comprobamos que no hay duplicados
sum(duplicated(datos$PassengerId))


#Agrupamos todos los parentescos familiares en una nueva columna
datos$Relatives=datos$SibSp+datos$Parch

#Borramos las columnas de SibSp y Parch
datos<-select(datos, -SibSp, -Parch)

## vemos la estructura de los datos
str(datos)
head(datos)
summary(datos)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## 3. Limpieza de los datos

###3.1 Elementos vacíos

Vamos a empezar haciendo un análisis de las columnas que contienen datos en blanco.

```{r}
# Números de valores desconocidos por campo
sapply(datos, function(x) sum(is.na(x)|x==""))

```
A continuación vamos a estimar la tarifa desconocida. Es un registro de puerto S y clase 3.

```{r}
casosS3<-filter(datos, Pclass==3 & datos$Embarked=="S")
mediaTarifaS3<-mean(casosS3$Fare,na.rm=TRUE)

#Asignamos el valor medio al dato perdido.
datos[153,"Fare"]<-mediaTarifaS3

```


### 3.2 Valores outliers.

```{r}
#Visualización de la edad
edad<-datos.bp<-boxplot(datos$Age,main="Edad")
edad$out

#Visualización de la tarifa
tarifa<-datos.bp<-boxplot(datos$Fare,main="Tarifa")
tarifa$out

#Visualización del número de famimliares
familiares<-datos.bp<-boxplot(datos$Relatives,main="Familiares")
familiares$out
```

# 4. Análisis de los datos

Lo primero que vamos a realizar es una discretización de los datos relativos al sexo, el puerto de embarque, la clase del billete y la supervivencia, que aunque vienen representados en enteros o cadenas, en realidad pertenecen a grupos que deben ser factorizados.

```{r}
# Discretizamos las variables con pocas clases
cols<-c("Survived","Pclass","Sex","Embarked")
for (i in cols){
  datos[,i] <- as.factor(datos[,i])
}

# Después de los cambios, analizamos la nueva estructura del conjunto de datos
str(datos)
```

Un primer análisis que puede resultar interesante es ver la relación entre el sexo del pasajero y su capacidad de supervivencia. 

```{r}
ggplot(data=datos,aes(x=Sex,fill=Survived))+geom_bar()
```
De esta primera consulta obtenemos visualmente una información bastante relevante: mientras que la gran mayoría de hombres falleció, la mayoría de las mujeres sobrevivieron.

Veamos qué sucede comparando con la clase en la que viajaban.

```{r}
ggplot(data = datos,aes(x=Pclass,fill=Survived))+geom_bar()
```
Vemos que el número de supervivientes es relativamente parecido en todas las categorías. Pero veamos qué sucede desde el punto de vista porcentual:


```{r}
ggplot(data = datos,aes(x=Pclass,fill=Survived))+geom_bar(position="fill")+ylab("Frecuencia")
```
Aquí comprobamos que los pasajeros de primera clase tenían más probabilidad de sobrevivir que los de segunda, y éstos más que los de tercera.


Por último, vamos a ver la relación entre las tres variables: Por cada clase (1, 2, 3) vemos el porcentaje de supervivientes.

```{r}
ggplot(data = datos,aes(x=Sex,fill=Survived))+geom_bar(position="fill")+facet_wrap(~Pclass)
```

Como dato llamativo, casi todas las mujeres de primera clase sobrevivieron, mientras que no lo hizo casi ningún hombre de segunda o tercera.

## 4.2. Comprobación de normalidad y homogeneidad de la varianza

Este concepto solo tiene sentido sobre variables numéricas; es decir, lo vamos a analizar sobre la edad y la tarifa.

```{r}
shapiro.test(datos$Age)
shapiro.test(datos$Fare)
```

En ambos casos obtenemos unos p-value muy pequeños que rechazan la hipótesis nula de normalidad.

Veamos qué sucede con la homocedasticidad (igualdad de varianza entre dos grupos).
Vamos a comprobarla en la edad y la tarifa para los grupos que sobrevivieron y lops que no

```{r}
leveneTest(Age ~ Survived, data = datos)
leveneTest(Fare ~ Survived, data = datos)
```


Vemos que, tomando alfa=0.05 como valor aceptado, la varianza en los grupos de supervivencia presenta homocedasticidad para el atributo edad pero no para la tarifa.


## 4.3 Aplicación de técnicas estadísticas.

Vamos a utilizar el test de chi cuadrado para ver la relación entre el sexo y la supervivencia.

```{r}
numHombresSuperV=sum(datos$Sex=='male' & datos$Survived==1)
numHombresNoSuperv=sum(datos$Sex=='male' & datos$Survived==0)
numMujeresSuperv=sum(datos$Sex=='female' & datos$Survived==1)
numMujeresNoSuperv=sum(datos$Sex=='female' & datos$Survived==0)

hombres=c(numHombresSuperV, numHombresNoSuperv)
mujeres=c(numMujeresSuperv, numMujeresNoSuperv)

sexoSuperv=as.data.frame(rbind(hombres, mujeres))
names(sexoSuperv) = c('Sobrevive', 'NoSobrevive')

sexoSuperv
chisq.test(sexoSuperv)
```
Obtenemos un p-value bajísimo, que indica diferencias significativas en los resultados de ambos grupos.
